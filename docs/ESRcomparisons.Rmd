---
title: "ESR Comparison Tables"
author: "Sarah Gaichas"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
  html_document:
    code_fold: hide
    toc: true
    toc_float: true
  word_document:
    toc: true
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)

library(tidyverse)
```


# Introduction, Methods, and Caveats

This document includes summary tables for the most recent Ecosystem Status Report (ESR) or other ecosystem information document for each U.S. Fishery Management Council region. Code to produce the summary datasets [`summtab.csv`](https://github.com/sgaichas/SAFMCindicators/blob/main/summtab.csv) and [`compesrdat.csv`](https://github.com/sgaichas/SAFMCindicators/blob/main/compesrdat.csv) that are used to produce these tables is contained in the document [`ESRsumms.Rmd`](https://github.com/sgaichas/SAFMCindicators/blob/main/docs/ESRsumms.Rmd). 

Draft ESR document summaries and R code to organize document section and indicator names into datasets were initially generated by Claude Sonnet 4.5 from each pdf file, then thoroughly reviewed and hand corrected where they inaccurately represented ESR content. Summaries were repeated using identical prompts on the same document for two ESRs from different regions to determine whether summaries were consistent. Differences between the replicate summaries were limited to formatting; section headings and indicators identified were consistent across replicates. 

However, note that while indicator counts given here should provide insight for comparisons across regional documents, they are approximate counts. There is interpretation required to count indicators: for example, are abundance and biomass from the same data source two indicators or one? Are time series for different species from the same source presented in one figure one single or multiple indicators? Are monthly vs. annual, local vs. regional sea surface temperature (SST) from the same source different indicators? When reviewing indicator summaries for each report, clearly different indicators were separated to the similar levels reported across all reports.

The code used below to compare indicators was human generated :-)

# Indicator Comparison

This table gives an overview of which Councils receive which reports, the reporting region, the most recent year of the report, report length, number of sections, approximate number of indicators (see note above), and the first and last section headers in each report. This give some insight into structural differences between the reports.

```{r ESRdat}

compesrdat <- readr::read_csv(here::here("compesrdat.csv"))

summtab <- readr::read_csv(here::here("summtab.csv"))

sectionindcounts <- compesrdat |>
  dplyr::group_by(Region, Year, Section) |>
  dplyr::summarise(Nind = n())

indcounts <- compesrdat |>
  dplyr::group_by(Region) |>
  dplyr::summarise(Nind = n())

sectioncounts <- compesrdat |>
  dplyr::select(Region, Year, Section) |>
  dplyr::distinct() |>
  dplyr::group_by(Region, Year) |>
  dplyr::summarise(Nsect = n())

order <- compesrdat |>
  dplyr::group_by(Region) |>
  dplyr::select(Section) |>
  dplyr::distinct() |>
  dplyr::mutate(order = 1:length(Section))


flextable::flextable(summtab) |>
  flextable::colformat_num(
    j = c("Year"), # Specify the columns to format
    big.mark = "",             # Set big.mark to an empty string to remove commas
    digits = 0                  # Specify the number of decimal places
  ) |>
  flextable::set_header_labels(
      Npages = "Total pages",
      Nsect = "Number of Sections",
      Nind = "Number of Indicators",
      First = "First Section",
      Last = "Last Section"
  ) |>
  flextable::set_table_properties(layout = "autofit", width = 1)


```

The following tables summarize each regional report in more detail. Press a tab to see the table for that region. 

This first set of tables shows the major report sections for each report and the approximate number of indicators in each section. Note that this leaves out introductory and summary sections for each report and focuses on the main indicator sections in each.

## Summary Tables by ESR {.tabset}

```{r allesrtabs, results='asis'}

esrs <- merge(sectionindcounts, order) |>
  dplyr::select(Region, Year, Section, Order= order, Nind) |>
  dplyr::arrange(Region, Order)
  
esrsls <- split(esrs, f = esrs$Region)

for(i in 1:length(esrsls)) {
  cat("  \n###",  names(esrsls[i]),"  \n")
  table <- flextable::flextable((esrsls[[i]]))|>
    flextable::colformat_num(
      j = c("Year"), # Specify the columns to format
      big.mark = "",             # Set big.mark to an empty string to remove commas
      digits = 0                  # Specify the number of decimal places
    ) |>
    flextable::set_header_labels(
      Nind = "Number of Indicators"
    ) |>
    flextable::set_table_properties(layout = "autofit", width = 1)
  flextable::flextable_to_rmd(table)
  cat("  \n")
}

```

## {-}

This second set of tables shows a detailed list of indicators for each report section. The tables can be long!

## Detailed Indicator Tables by ESR {.tabset}

```{r allesrdetailtabs, results='asis'}

esrsdetls <- split(compesrdat, f = compesrdat$Region)

for(i in 1:length(esrsdetls)) {
  cat("  \n###",  names(esrsdetls[i]),"  \n")
  table <- flextable::flextable((esrsdetls[[i]]))|>
    flextable::colformat_num(
      j = c("Year"), # Specify the columns to format
      big.mark = "",             # Set big.mark to an empty string to remove commas
      digits = 0                  # Specify the number of decimal places
    ) |>
    flextable::set_table_properties(layout = "autofit", width = 1) 
  flextable::flextable_to_rmd(table)
  cat("  \n")
}

```

## {-}

Here I include the ESR text summaries generated by Claude 4.5 and checked for accuracy.

## ESR Summaries {.tabset}

```{r, results='asis'}
#
# this didnt work as a chunk header, cant do a section apparently child = 'ESRsumms.Rmd#sa-summary'
# try reading the rendered html that isn't posted

ESRnames <- names(esrsls)
ESRsummsect <- c("ai-summary", "calcur-summary", "carib-summary", "ebs-summary", "gom-summary", "goa-summary",
                 "hi-summary", "ma-summary", "ne-summary", "sa-summary")

for(i in 1:length(ESRnames)){
  
  cat("  \n###",  ESRnames[i],"  \n")
  
  html_content <- rvest::read_html(here::here("docs/ESRsumms.html"))
  
  extracted_section <- html_content |>
    rvest::html_nodes(paste0("div#", ESRsummsect[i])) |> # Use your specific CSS selector here
    rvest::html_text() # or html_children() if you need the raw HTML elements
  
  cat(paste0("<pre>", extracted_section, "</pre>")) # need to add the html tags for it to respect newlines
  cat("  \n")
}
```


## {-}
